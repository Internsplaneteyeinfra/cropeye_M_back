{% extends "admin/change_form.html" %}
{% load static %}

{% block extrahead %}
    {{ block.super }}
    {{ media }} 
    <style>
        /* Hide the green plus (add) icon from Django admin ForeignKey popup icons */
        .related-widget-wrapper .add-related,
        .related-widget-wrapper a[href*="add/"],
        .add-related,
        .addlink,
        a.add-related {
            display: none !important;
            visibility: hidden !important;
        }
        
        /* Field-specific hiding */
        .field-plantation_type .related-widget-wrapper a[href*="add/"],
        .field-planting_method .related-widget-wrapper a[href*="add/"],
        .field-plantation_type .add-related,
        .field-planting_method .add-related {
            display: none !important;
            visibility: hidden !important;
        }
        
        /* Hide by href pattern */
        a[href*="/add/"],
        a[href*="add/"] {
            display: none !important;
            visibility: hidden !important;
        }
        
        /* Hide buttons with add text in title */
        button[title*="Add"],
        a[title*="Add"] {
            display: none !important;
            visibility: hidden !important;
        }
    </style>
{% endblock %}

{% block admin_change_form_document_ready %}
    {{ block.super }}
    <script>
    (function($) {
        'use strict';
        
        // Plantation type choices based on crop category
        var PLANTATION_TYPE_CHOICES = {
            'sugarcane': [
                ['', '---------'],
                ['adsali', 'Adsali'],
                ['suru', 'Suru'],
                ['ratoon', 'Ratoon'],
                ['pre-seasonal', 'Pre-Seasonal'],
                ['post-seasonal', 'Post-Seasonal'],
                ['other', 'Other']
            ],
            'grapes': [
                ['', '---------'],
                ['wine', 'Wine Grapes'],
                ['table', 'Table Grapes'],
                ['late', 'Late'],
                ['early', 'Early'],
                ['pre_season', 'Pre-Season'],
                ['seasonal', 'Seasonal']
            ]
        };
        
        // Planting method choices (only for sugarcane)
        var PLANTING_METHOD_CHOICES = {
            'sugarcane': [
                ['', '---------'],
                ['3_bud', '3 Bud Method'],
                ['2_bud', '2 Bud Method'],
                ['1_bud', '1 Bud Method'],
                ['1_bud_stip_Method', '1 Bud (stip Method)'],
                ['other', 'Other']
            ],
            'grapes': []  // No planting method for grapes
        };
        
        function updateDropdowns() {
            var cropCategorySelect = document.getElementById('id_crop_category');
            var plantationTypeSelect = document.getElementById('id_plantation_type');
            var plantingMethodSelect = document.getElementById('id_planting_method');
            var plantingMethodRow = $('.field-planting_method');
            
            if (!cropCategorySelect) {
                console.log('Crop category select not found');
                return;
            }
            
            var selectedCategory = cropCategorySelect.value;
            console.log('Selected crop category:', selectedCategory);
            
            // Get current values before clearing
            var currentPlantationType = plantationTypeSelect ? plantationTypeSelect.value : '';
            var currentPlantingMethod = plantingMethodSelect ? plantingMethodSelect.value : '';
            
            // Update plantation type dropdown
            if (plantationTypeSelect) {
                var plantationChoices = PLANTATION_TYPE_CHOICES[selectedCategory] || PLANTATION_TYPE_CHOICES['sugarcane'];
                
                // Clear existing options
                plantationTypeSelect.innerHTML = '';
                
                // Add new options
                plantationChoices.forEach(function(choice) {
                    var option = document.createElement('option');
                    option.value = choice[0];
                    option.textContent = choice[1];
                    if (choice[0] === currentPlantationType) {
                        option.selected = true;
                    }
                    plantationTypeSelect.appendChild(option);
                });
            }
            
            // Update planting method dropdown
            if (plantingMethodSelect) {
                var methodChoices = PLANTING_METHOD_CHOICES[selectedCategory] || [];
                
                // Clear existing options
                plantingMethodSelect.innerHTML = '';
                
                if (methodChoices.length > 0) {
                    // Add new options
                    methodChoices.forEach(function(choice) {
                        var option = document.createElement('option');
                        option.value = choice[0];
                        option.textContent = choice[1];
                        if (choice[0] === currentPlantingMethod) {
                            option.selected = true;
                        }
                        plantingMethodSelect.appendChild(option);
                    });
                    // Show the row
                    plantingMethodRow.show();
                } else {
                    // Hide the row for grapes
                    plantingMethodRow.hide();
                }
            }
        }
        
        $(document).ready(function() {
            // Hide add buttons
            $('.field-plantation_type select, .field-planting_method select').each(function() {
                $(this).next('a, button').hide();
                $(this).siblings('a, button').hide();
            });
            $('a[href*="add/"]').hide();
            
            // Initialize dropdowns on page load
            updateDropdowns();
            
            // Update dropdowns when crop category changes
            var cropCategorySelect = document.getElementById('id_crop_category');
            if (cropCategorySelect) {
                cropCategorySelect.addEventListener('change', function() {
                    console.log('Crop category changed to:', this.value);
                    updateDropdowns();
                });
            }
        });
        
    })(django.jQuery || jQuery);
    </script>
{% endblock %}
